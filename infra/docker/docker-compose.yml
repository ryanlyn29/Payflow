version: '3.8'

networks:
  paysignal-network:
    driver: bridge

services:
  postgres:
    image: postgres:16-alpine
    container_name: paysignal-postgres
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-paysignal}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ../backend/node-api/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - paysignal-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-postgres}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: paysignal-redis
    command: redis-server --appendonly yes
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - paysignal-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  node-api:
    build:
      context: ../../backend/node-api
      dockerfile: Dockerfile
    container_name: paysignal-node-api
    ports:
      - "${PORT:-8080}:8080"
    env_file:
      - ../../.env
    environment:
      NODE_ENV: ${NODE_ENV:-development}
      PORT: ${PORT:-8080}
      APP_VERSION: ${APP_VERSION:-1.0.0}
      LOG_LEVEL: ${LOG_LEVEL:-info}
      
      # Database
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-paysignal}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      POSTGRES_MAX_CONNECTIONS: ${POSTGRES_MAX_CONNECTIONS:-20}
      POSTGRES_MIN_CONNECTIONS: ${POSTGRES_MIN_CONNECTIONS:-2}
      POSTGRES_IDLE_TIMEOUT: ${POSTGRES_IDLE_TIMEOUT:-30000}
      POSTGRES_CONNECTION_TIMEOUT: ${POSTGRES_CONNECTION_TIMEOUT:-5000}
      POSTGRES_STATEMENT_TIMEOUT: ${POSTGRES_STATEMENT_TIMEOUT:-30000}
      POSTGRES_QUERY_TIMEOUT: ${POSTGRES_QUERY_TIMEOUT:-30000}
      
      # Redis
      REDIS_URL: redis://redis:6379
      REDIS_CONNECT_TIMEOUT: ${REDIS_CONNECT_TIMEOUT:-5000}
      REDIS_PING_INTERVAL: ${REDIS_PING_INTERVAL:-30000}
      
      # Auth - loaded from .env file via env_file
      JWT_SECRET: ${JWT_SECRET}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET}
      JWT_EXPIRY: ${JWT_EXPIRY:-15m}
      REFRESH_TOKEN_EXPIRY: ${REFRESH_TOKEN_EXPIRY:-7d}
      
      # OAuth - loaded from .env file via env_file
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET}
      BACKEND_URL: ${BACKEND_URL:-http://localhost:8080}
      
      # Frontend
      FRONTEND_URL: ${FRONTEND_URL:-http://localhost:3000}
      BASE_URL: ${BASE_URL:-http://localhost:3000}
      
      # Rate Limiting
      RATE_LIMIT_ENABLED: ${RATE_LIMIT_ENABLED:-true}
      RATE_LIMIT_MONITORING_MAX: ${RATE_LIMIT_MONITORING_MAX:-60}
      RATE_LIMIT_API_MAX: ${RATE_LIMIT_API_MAX:-1000}
      RATE_LIMIT_AUTH_MAX: ${RATE_LIMIT_AUTH_MAX:-100}
      
      # Service URLs
      GO_WORKER_SERVICE_URL: http://go-worker:8082
    networks:
      - paysignal-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health/liveness"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped

  go-worker:
    build:
      context: ../../backend/go-worker
      dockerfile: Dockerfile
    container_name: paysignal-go-worker
    ports:
      - "${GO_WORKER_PORT:-8082}:8082"
    env_file:
      - ../../.env
    environment:
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      POSTGRES_DB: ${POSTGRES_DB:-paysignal}
      POSTGRES_USER: ${POSTGRES_USER:-postgres}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-postgres}
      REDIS_URL: redis://redis:6379
      # AWS Configuration
      AWS_REGION: ${AWS_REGION:-us-east-1}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      # SQS Configuration
      SQS_QUEUE_URL: ${SQS_QUEUE_URL}
      SQS_DLQ_URL: ${SQS_DLQ_URL}
    networks:
      - paysignal-network
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    restart: unless-stopped

  react-frontend:
    build:
      context: ../../frontend/react
      dockerfile: Dockerfile
      args:
        VITE_API_BASE_URL: ${VITE_API_BASE_URL:-http://localhost:8080/api/v1}
    container_name: paysignal-frontend
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    networks:
      - paysignal-network
    depends_on:
      node-api:
        condition: service_healthy
    restart: unless-stopped

volumes:
  postgres_data:
  redis_data:



